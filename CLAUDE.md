# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a Terraform module for Yandex Cloud Container Registry. It creates container registries with repositories, IAM bindings, lifecycle policies, and IP permissions.

**Provider:** yandex-cloud/yandex (>= 0.47.0)
**Terraform:** >= 1.3

## Common Commands

### Validation and Formatting
```bash
terraform fmt --recursive           # Format all .tf files
terraform fmt --recursive -check    # Check formatting without changes
terraform validate                  # Validate configuration (requires init)
terraform init                      # Initialize module (run in examples/simple for testing)
```

### Linting (CI uses these)
```bash
tflint --init && tflint -f compact  # Run TFLint
```

### Pre-commit Hooks
```bash
pre-commit run --all-files          # Run all hooks (fmt, validate, docs, tflint)
pre-commit install                  # Install hooks
```

### Documentation
The README.md between `<!-- BEGIN_TF_DOCS -->` and `<!-- END_TF_DOCS -->` is auto-generated by terraform-docs via pre-commit hooks.

## Module Architecture

The module creates resources in this hierarchy:

1. **Registry** (`yandex_container_registry.this`) - Single container registry per module instance
2. **Registry IAM** (`yandex_container_registry_iam_binding.this`) - Registry-level role binding (puller/pusher/admin)
3. **Registry IP Permissions** (`yandex_container_registry_ip_permission.this`) - Optional IP-based access control
4. **Repositories** (`yandex_container_repository.this`) - Multiple repos via `for_each` on `var.repos`
5. **Repository IAM** (`yandex_container_repository_iam_binding.this`) - Per-repository role bindings
6. **Lifecycle Policies** (`yandex_container_repository_lifecycle_policy.this`) - Per-repository image cleanup rules

## Key Variables

- `registry` (required): Registry name
- `role`: Registry-level role - must be `puller`, `pusher`, or `admin`
- `members`: IAM members for registry-level binding (format: `system:allUsers`, `serviceAccount:{id}`, etc.)
- `repos`: Map of repositories, each with optional `role`, `members`, and `lifecycle_policy`
- `registry_ip_permission`: Optional push/pull IP allowlists (CIDR format)

## Validation Rules

- `expire_period` in lifecycle policies must be multiples of 24 hours (e.g., "24h", "48h", "168h")
- IP permissions must be valid CIDR notation
- Member formats are validated against Yandex Cloud IAM patterns
